<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8" />
    <title>Test coverage report: sqk.datasets.tasks</title>
    <style type="text/css" media="screen">
      a
      {
        color: #3d707a;
      }
      
      a:hover, a:active
      {
        color: #bf7d18;
      }
    
      body 
      {
        font-family: "Lucida Sans Unicode", "Lucida Grande", sans-serif;
        font-size: 13px;
      }
      
      .nav 
      {
        font-size: 12px;
        margin-left: 50px;
      }

      .ignored
      {
        color: #707070;
      }

      .executed 
      {
        color: #3d9900;
      }

      .missed 
      {
        color: red;
        font-weight: bold;
      }

      .excluded 
      {
        color: #6090f0;
        font-weight: lighter;
      }
    
      #content-header 
      {
        font-size: 12px;
        padding: 18px 0 18px 50px;
      }

      #content-header h1 
      {
        font-size: 16px;
        margin: 10px 0 0 0;
        color: #909090;
      }
      
      #module-name
      {
        color: #583707;
      }
    
      #content-header p
      {
        font-size: 13px;
        margin: 0;
        color: #909090;
      }

      #content-header .normal 
      {
        color: #609030;
      }

      #content-header .warning 
      {
        color: #d0a000;
      }

      #content-header .critical 
      {
        color: red;
      }
      
      #source-listing 
      {
        margin-bottom: 24px;
      }

      #source-listing ol 
      {
        padding: 0 0 0 50px;
        width: 90%;
        font-family: monospace;
        list-style-position: outside;
      }

      #source-listing ol li 
      {
        line-height: 18px;
        font-size: small;
      }
        
      #source-listing ol code 
      {
        padding:  0 .001em 0 0; /* Firefox doesn't render empty li's properly */
        font-size: medium;
        white-space: pre;
      }
   </style>
  </head>

  <body>

<div class="nav">
  <a href="sqk.datasets.models.html">sqk.datasets.models</a> &lt;&lt;
  <a href="../index.html">index</a>
  &gt;&gt; <a href="sqk.datasets.templatetags.dataset_tags.html">sqk.datasets.templatetags.dataset_tags</a>
</div>

<div id="content-header">
  <h1>
    <span id="module-name">sqk.datasets.tasks</span>:
    110 total statements,
    <span class="critical">0.0% covered</span>
  </h1>
  <p>Generated: Thu 2013-01-03 19:11 CST</p>
  <p>Source file: /Users/sloria1/projects/django_projects/sqk/sqk/datasets/tasks.py</p>
  <p>
    Stats:
    <span class="executed">0 executed</span>,
    <span class="missed">102 missed</span>,
    <span class="excluded">8 excluded</span>,
    <span class="ignored">90 ignored</span> 
  </p> 
</div>

<div id="source-listing">
  <ol>
    <li class="excluded"><code>import csv</code></li>
<li class="excluded"><code>import os</code></li>
<li class="excluded"><code>from django.conf import settings</code></li>
<li class="ignored"><code></code></li>
<li class="excluded"><code>import yaafelib as yf</code></li>
<li class="excluded"><code>import wave</code></li>
<li class="excluded"><code>import contextlib</code></li>
<li class="excluded"><code>from celery import task</code></li>
<li class="ignored"><code></code></li>
<li class="excluded"><code>from models import *</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>@task()</code></li>
<li class="ignored"><code>def handle_uploaded_file(f):</code></li>
<li class="ignored"><code>    '''Saves an uploaded data source to MEDIA_ROOT/data_sources</code></li>
<li class="ignored"><code>    '''</code></li>
<li class="missed"><code>    with open(os.path.join(settings.MEDIA_ROOT, 'data_sources', f.name), 'wb+') as destination:</code></li>
<li class="missed"><code>        for chunk in f.chunks():</code></li>
<li class="missed"><code>            destination.write(chunk)</code></li>
<li class="missed"><code>        return destination</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>@task()</code></li>
<li class="missed"><code>def read_datasource(dataset, source_path, feature_row=0):</code></li>
<li class="ignored"><code>    '''Parse a datasource (csv) and saves data to the database.</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>    IMPORTANT: As of now, this method is for demo purposes. It assumes</code></li>
<li class="ignored"><code>    that the the independent variable is in the last row.</code></li>
<li class="ignored"><code>    '''</code></li>
<li class="missed"><code>    with open(source_path, 'r') as s:</code></li>
<li class="ignored"><code>        # TODO: file type handling</code></li>
<li class="missed"><code>        data = csv.reader(s)</code></li>
<li class="missed"><code>        features = []  # List of feature names</code></li>
<li class="missed"><code>        feature_obj_list = []  # List of feature objects</code></li>
<li class="missed"><code>        label_name = None</code></li>
<li class="missed"><code>        for i, row in enumerate(data):</code></li>
<li class="ignored"><code>            # Parse header</code></li>
<li class="missed"><code>            if i == feature_row:</code></li>
<li class="missed"><code>                for j in range(len(row) - 1):</code></li>
<li class="missed"><code>                    features.append(row[j].lower())</code></li>
<li class="missed"><code>                    f = None</code></li>
<li class="ignored"><code>                    # Create feature if it doesn't exist</code></li>
<li class="missed"><code>                    if Feature.objects.filter(name=row[j].lower()).count() == 0:</code></li>
<li class="missed"><code>                        f = Feature.objects.create(name=row[j].lower())</code></li>
<li class="ignored"><code>                    else:</code></li>
<li class="missed"><code>                        f = Feature.objects.filter().get(</code></li>
<li class="ignored"><code>                            name=row[j].lower())</code></li>
<li class="missed"><code>                    feature_obj_list.append(f)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>                label_name = LabelName.objects.create(</code></li>
<li class="ignored"><code>                    name=row[-1])</code></li>
<li class="ignored"><code>            # Parse data</code></li>
<li class="ignored"><code>            else:</code></li>
<li class="ignored"><code>                # Create instance and add it to dataset</code></li>
<li class="missed"><code>                inst = Instance.objects.create(</code></li>
<li class="ignored"><code>                    dataset=dataset)</code></li>
<li class="missed"><code>                for feature in feature_obj_list:</code></li>
<li class="missed"><code>                    inst.features.add(feature)</code></li>
<li class="missed"><code>                inst.save()</code></li>
<li class="missed"><code>                for v, value_str in enumerate(row):</code></li>
<li class="ignored"><code>                    # Process datum</code></li>
<li class="missed"><code>                    try:</code></li>
<li class="missed"><code>                        val = float(value_str)</code></li>
<li class="missed"><code>                    except ValueError:</code></li>
<li class="ignored"><code>                        # Ignore non-numerical data</code></li>
<li class="ignored"><code>                        # TODO: Eventually accept non-numeric data</code></li>
<li class="missed"><code>                        continue</code></li>
<li class="missed"><code>                    feature = None</code></li>
<li class="missed"><code>                    feature = inst.features.get(name=features[v])</code></li>
<li class="missed"><code>                    v = FeatureValue.objects.create(value=val,</code></li>
<li class="ignored"><code>                            feature=feature,</code></li>
<li class="ignored"><code>                            instance=inst)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>                print row[-1]</code></li>
<li class="ignored"><code>                # Create label value and add it to the label</code></li>
<li class="missed"><code>                label_value_obj, created = LabelValue.objects.get_or_create(</code></li>
<li class="ignored"><code>                                            value=row[-1].lower(),</code></li>
<li class="ignored"><code>                                            label_name=label_name)</code></li>
<li class="missed"><code>                inst.label_values.add(label_value_obj)</code></li>
<li class="missed"><code>                inst.save()</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>@task()</code></li>
<li class="ignored"><code>def extract_features(dataset_id, instance_id, audiofile_path):</code></li>
<li class="missed"><code>    dataset = Dataset.objects.get(pk=dataset_id)</code></li>
<li class="missed"><code>    inst = Instance.objects.get(pk=instance_id)</code></li>
<li class="missed"><code>    n_frames, sample_rate, duration = 0, 0, 0</code></li>
<li class="missed"><code>    with contextlib.closing(wave.open(audiofile_path, 'r')) as audiofile:</code></li>
<li class="missed"><code>        n_frames = audiofile.getnframes()</code></li>
<li class="missed"><code>        sample_rate = audiofile.getframerate()</code></li>
<li class="missed"><code>        duration = n_frames / float(sample_rate)</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>    # Format - {'Display name': 'name: Definition'}</code></li>
<li class="missed"><code>    FEATURES = {'Spectral Shape Characteristics': 'sss: SpectralShapeStatistics',</code></li>
<li class="ignored"><code>                'Temporal Shape Characteristics': 'tss: TemporalShapeStatistics',</code></li>
<li class="ignored"><code>                'ZCR': 'zcr: ZCR',</code></li>
<li class="ignored"><code>                'Energy': 'energy: Energy',</code></li>
<li class="ignored"><code>                'Loudness': 'loudness: Loudness',</code></li>
<li class="ignored"><code>                'Spectral rolloff': 'spectral_rolloff: SpectralRolloff',</code></li>
<li class="ignored"><code>                'Perceptual sharpness': 'perceptual_sharpness: PerceptualSharpness',</code></li>
<li class="ignored"><code>                'Perceptual spread': 'perceptual_spread: PerceptualSpread',</code></li>
<li class="ignored"><code>                'Duration': None,</code></li>
<li class="ignored"><code>                'Sample rate': None}</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>    # Add features to extract</code></li>
<li class="missed"><code>    feature_plan = yf.FeaturePlan(sample_rate=sample_rate, resample=False)</code></li>
<li class="missed"><code>    for feature_definition in FEATURES.values():</code></li>
<li class="missed"><code>        if feature_definition:  # Exclude duration and sample rate</code></li>
<li class="missed"><code>            feature_plan.addFeature(feature_definition)</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>    # Configure an Engine</code></li>
<li class="missed"><code>    engine = yf.Engine()</code></li>
<li class="missed"><code>    engine.load(feature_plan.getDataFlow())</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>    # Extract features</code></li>
<li class="missed"><code>    afp = yf.AudioFileProcessor()</code></li>
<li class="missed"><code>    afp.processFile(engine, audiofile_path)</code></li>
<li class="ignored"><code>    # outputs dict format - {'Spectral centroid': [[2.33], [4.34],...[2.55]]}</code></li>
<li class="missed"><code>    outputs = {}</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>    # Read and store output arrays to outputs dict</code></li>
<li class="missed"><code>    for display_name, definition in FEATURES.iteritems():</code></li>
<li class="missed"><code>        if definition:  # ex: 'loudness'</code></li>
<li class="missed"><code>            output_name = definition.split(':')[0].strip()</code></li>
<li class="missed"><code>            if output_name == 'sss':  # Store separate spec shape stats</code></li>
<li class="missed"><code>                spec_shape_stats = engine.readOutput(output_name)</code></li>
<li class="missed"><code>                outputs['Spectral centroid'] = spec_shape_stats[:, 0]</code></li>
<li class="missed"><code>                outputs['Spectral spread'] = spec_shape_stats[:, 1]</code></li>
<li class="missed"><code>                outputs['Spectral skewness'] = spec_shape_stats[:, 2]</code></li>
<li class="missed"><code>                outputs['Spectral kurtosis'] = spec_shape_stats[:, 3]</code></li>
<li class="missed"><code>            elif output_name == 'tss':</code></li>
<li class="missed"><code>                temp_shape_stats = engine.readOutput(output_name)</code></li>
<li class="missed"><code>                outputs['Temporal centroid'] = temp_shape_stats[:, 0]</code></li>
<li class="missed"><code>                outputs['Temporal spread'] = temp_shape_stats[:, 1]</code></li>
<li class="missed"><code>                outputs['Temporal skewness'] = temp_shape_stats[:, 2]</code></li>
<li class="missed"><code>                outputs['Temporal kurtosis'] = temp_shape_stats[:, 3]</code></li>
<li class="ignored"><code>            else:  # 1 dimensional data (1 X T array)</code></li>
<li class="missed"><code>                a = engine.readOutput(output_name)  # 2D array</code></li>
<li class="missed"><code>                outputs[display_name] = a.transpose()[0]</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>    # Create YAAFE feature objects</code></li>
<li class="missed"><code>    feature_obj_list = []</code></li>
<li class="missed"><code>    for display_name in outputs.keys():</code></li>
<li class="missed"><code>        f, created = Feature.objects.get_or_create(name=display_name.lower())</code></li>
<li class="missed"><code>        feature_obj_list.append(f)</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>    # Create Sample rate and Duration objects</code></li>
<li class="missed"><code>    rate_obj, created = Feature.objects.get_or_create(name='sample rate')</code></li>
<li class="missed"><code>    feature_obj_list.append(rate_obj)</code></li>
<li class="missed"><code>    duration_obj, created = Feature.objects.get_or_create(name='duration')</code></li>
<li class="missed"><code>    feature_obj_list.append(duration_obj)</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>    # Associate features with instance</code></li>
<li class="missed"><code>    for feature in feature_obj_list:</code></li>
<li class="missed"><code>        inst.features.add(feature)</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>    # If dataset has labels</code></li>
<li class="missed"><code>    if dataset.labels():</code></li>
<li class="ignored"><code>        # NOTE: This assumes there's only one label name per dataset.</code></li>
<li class="ignored"><code>        # Just indexes the first label name</code></li>
<li class="missed"><code>        label_name = dataset.labels()[0]</code></li>
<li class="ignored"><code>    else:</code></li>
<li class="ignored"><code>        # attach a placeholder LabelName called 'variable'</code></li>
<li class="missed"><code>        filtered = LabelName.objects.filter(name='variable')</code></li>
<li class="ignored"><code>        # make sure that 'get' doesn't return an error if there are more than 1</code></li>
<li class="ignored"><code>        # LabelName called 'variable'</code></li>
<li class="missed"><code>        if len(filtered) &lt;= 1:</code></li>
<li class="missed"><code>            label_name, c = LabelName.objects.get_or_create(name='variable')</code></li>
<li class="ignored"><code>        else:</code></li>
<li class="missed"><code>            label_name = filtered[0]</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>    # Add a placeholder label value called "none" to instance</code></li>
<li class="ignored"><code>    # This is necessary in order for plotting to work</code></li>
<li class="missed"><code>    filtered = LabelValue.objects.filter(value="none", label_name=label_name)</code></li>
<li class="missed"><code>    if len(filtered) &lt;= 1:</code></li>
<li class="missed"><code>        no_label, c = LabelValue.objects.get_or_create(value="none",</code></li>
<li class="ignored"><code>                                                    label_name=label_name)</code></li>
<li class="ignored"><code>    else:</code></li>
<li class="missed"><code>        no_label = filtered[0]</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    inst.label_values.add(no_label)</code></li>
<li class="missed"><code>    inst.save()</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>    # Save output data and associate it with inst</code></li>
<li class="missed"><code>    for display_name, output in outputs.iteritems():</code></li>
<li class="missed"><code>        if output.size &gt; 0:  # Avoid empty data</code></li>
<li class="missed"><code>            for i in range(output[0].size):</code></li>
<li class="missed"><code>                output_mean = output[i].mean()</code></li>
<li class="missed"><code>                FeatureValue.objects.create(value=output_mean,</code></li>
<li class="ignored"><code>                    feature=Feature.objects.get(name__iexact=display_name.lower()),</code></li>
<li class="ignored"><code>                    instance=inst)</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>    # Save sample_rate and duration data</code></li>
<li class="missed"><code>    FeatureValue.objects.create(value=sample_rate,</code></li>
<li class="ignored"><code>        feature=Feature.objects.get(name='sample rate'),</code></li>
<li class="ignored"><code>        instance=inst)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    FeatureValue.objects.create(value=duration,</code></li>
<li class="ignored"><code>        feature=Feature.objects.get(name='duration'),</code></li>
<li class="ignored"><code>        instance=inst)</code></li>
  </ol>
</div>

<div class="nav">
  <a href="sqk.datasets.models.html">sqk.datasets.models</a> &lt;&lt;
  <a href="../index.html">index</a>
  &gt;&gt; <a href="sqk.datasets.templatetags.dataset_tags.html">sqk.datasets.templatetags.dataset_tags</a>
</div>

  </body>
</html>

