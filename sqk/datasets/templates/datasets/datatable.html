{% load url from future %}
{% load staticfiles %}
<script>
var oTable;
$(document).ready(function() {
  var initial_display_length = 10;

    // Initialize dataset as a DataTable
    try{
      oTable = $('#dataset-table').dataTable( {
       "sDom": 'T<"clear">lfrtip',
       "sScrollY": "350px",
       "sScrollX": "100%",
       "sScrollXInner": "130%",
       "bScrollCollapse": true,
       "bPaginate": false,
       "oLanguage": {
        "sLengthMenu": " _MENU_ instances per page"
      },
      "oTableTools": {
        "sSwfPath": "{{ STATIC_URL }}tabletools/swf/copy_csv_xls_pdf.swf",
        "sRowSelect": "multi",
        /* Datatable TableTools Buttons */
        "aButtons": [
        // Select All
        {
          "sExtends": "select_all",
          "sButtonText": '<i class="icon-check"></i> All'
        },
        // Select None
        {
          "sExtends": "select_none",
          "sButtonText": '<i class="icon-check-empty"></i> None'
        },

        // Update label values
        {
          "sExtends": "text",
          "sButtonText": '<i class="icon-pencil"></i> Change variable value',
          "fnClick": function(nButton, oConfig, oFlash){
            var ret = prompt("Enter the new value  : ", "");
            if (ret){
              update_selected_labels(ret);
            }
          }
        },

        // Delete selected
        {
          "sExtends":    "text",
          "sButtonText": '<i class="icon-trash"></i> Delete selected',
          "fnClick": function ( nButton, oConfig, oFlash ) {
            var answer = confirm("Delete selected instances?\nWARNING: This operation is irreversible.")
            if (answer){
              delete_selected();
            }
          }
        },

        // Export csv
        {
          "sExtends": "csv",
          "sButtonText": '<i class="icon-file"></i> Export CSV'
        },

        // Print
        {
          "sExtends": "print",
          "sButtonText": '<i class="icon-print"></i> Print'
        }
        ]
      },
      "iDisplayLength": initial_display_length,
      "bFilter": true, // Disable search
      "aoColumnDefs": [
          // Specifiy columns that aren't sortable
          { 'bSortable': false, 'aTargets': [ 0 ] },
          // { "sWidth": 1, "aTargets": [ 0 ] }
          ]
        } );
      // Fix left columns
      new FixedColumns( oTable,{
        "iLeftColumns": 2,
        "iLeftWidth": 100
      } );
}catch(ex){
  console.log('Caught exception when initializing dataset:');
  console.log(ex);
  console.log('but the show must go on...')
}
});


/* Only include these functions if there is data,
otherwise, the url tags will cause an error. */
{% if dataset.instances.all %} 
function delete_selected(){
  /* Deletes the selected instances. NOTE: Deletions persist to the db. */
  var oTT = TableTools.fnGetInstance( 'dataset-table' );
  var selected = oTT.fnGetSelected( oTable );
  // Remove selected from table
  $.ajax({
    url: "{% url 'datasets:delete_instances' dataset.pk %}",
    type: "POST",
    data: {"selected": get_selected_ids(selected)},
    dataType: 'json',
    success: function(data) {
      // On success, dynamically delete selected rows from table
      $.each(selected, function(index, value){
        oTable.fnDeleteRow( selected[index] );
      });
      // TODO: update scatterplot to reflect deleted instances
      // For now, just refresh the page
      document.location.reload(true);
    },
    crossDomain: false,
    cache: false,
  });
}

function update_selected_labels(new_label){
  /* Deletes the selected instances. NOTE: Deletions persist to the db. */
  var oTT = TableTools.fnGetInstance( 'dataset-table' );
  var selected = oTT.fnGetSelected( oTable );
  // Remove selected from table
  $.ajax({
    url: "{% url 'datasets:update_instances_labels' dataset.pk label_name_id %}",
    type: "POST",
    data: {"new_label": new_label, "selected": get_selected_ids(selected)},
    dataType: 'json',
    /* Reloads after success
    TODO: make this ajax in the future? */
    success: function(data){
      document.location.reload(true);
    },
    crossDomain: false,
    cache: false,
  });
}

function get_selected_ids( selected )
/* Returns an array of ids for the selected instances. */
{
  return jQuery.map(selected, function(element) { return jQuery(element).data('id'); });
}
{% endif %}

</script>