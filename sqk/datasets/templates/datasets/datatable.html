{% load url from future %}
{% load staticfiles %}
<script>
var oTable;
$(document).ready(function() {
  var initial_display_length = 10;
  // index of the last column
  var i_last_column = {{ feature_names|length }} + {{ label_names|length }} + 3;

  // Remove success highlighting if clicking off of rows
  $('body').click(function() {
    $('.success').removeClass('success');
  });

    // Initialize dataset as a DataTable
    try{
      oTable = $('#dataset-table').dataTable( {
       "sDom": 'T<"clear">lfrtip',
        "aaSorting": [[ 1, 'asc' ]],
       "sScrollY": "350px",
       "sScrollX": "100%",
       // Affects the extent of X-scrolling (higher => more scrolling)
       "sScrollXInner": "150%",
       "bScrollCollapse": true,
       "bPaginate": false,
       "oLanguage": {
        "sLengthMenu": " _MENU_ instances per page"
      },
      "oTableTools": {
        "sSwfPath": "{{ STATIC_URL }}tabletools/swf/copy_csv_xls_pdf.swf",
        "sRowSelect": "multi",
        /* Datatable TableTools Buttons */
        "aButtons": [
        // Select All
        {
          "sExtends": "select_all",
          "sButtonText": '<i class="icon-check"></i> All'
        },
        // Select None
        {
          "sExtends": "select_none",
          "sButtonText": '<i class="icon-check-empty"></i> None'
        },

        // Update label values
        {
          "sExtends": "text",
          "sButtonText": '<i class="icon-pencil"></i> Change variable value',
          "fnClick": function(nButton, oConfig, oFlash){
            var ret = prompt("Enter the new value  : ", "");
            if (ret){
              update_selected_labels(ret);
            }
          }
        },

        // Delete selected
        {
          "sExtends":    "text",
          "sButtonText": '<i class="icon-trash"></i> Delete',
          "fnClick": function ( nButton, oConfig, oFlash ) {
            var answer = confirm("Delete selected instances?\nWARNING: This operation is irreversible.")
            if (answer){
              delete_selected();
            }
          }
        },

        // Export csv
        {
          "sExtends": "csv",
          "sButtonText": '<i class="icon-file"></i> Export CSV'
        },
        ]
      },
      "iDisplayLength": initial_display_length,
      "bFilter": true, // Disable search
      "aoColumnDefs": [
          // Specifiy columns that aren't sortable
          { 'bSortable': false, 'aTargets': [ 0 ] },
          // Make the date column wider so that it doesn't create 2 rows
          { "sWidth": '20%', "aTargets": [ i_last_column ] }
          ]
        } );
      // Fix left columns
      new FixedColumns( oTable,{
        "iLeftColumns": 2,
        "iLeftWidth": 100
      } );
}catch(ex){
  console.log('Caught exception when initializing dataset:');
  console.log(ex);
  console.log('but the show must go on...')
}
});


/* Only include these functions if there is data,
otherwise, the url tags will cause an error. */
{% if not is_empty %} 
function delete_selected(){
  /* Deletes the selected instances. NOTE: Deletions persist to the db. */
  var oTT = TableTools.fnGetInstance( 'dataset-table' );
  var selected = oTT.fnGetSelected( oTable );
  // Remove selected from table
  $.ajax({
    url: "{% url 'datasets:delete_instances' dataset.pk %}",
    type: "POST",
    data: {"selected": get_selected_ids(selected)},
    dataType: 'json',
    success: function(new_data) {
      oTT.fnSelectNone();
      // On success, dynamically delete selected rows from table
      $.each(selected, function(index, value){
        oTable.fnDeleteRow( selected[index] );
      });
      // Update plot
      data = new_data;
      scatterPlot();
    },
    crossDomain: false,
    cache: false,
  });
}

function update_selected_labels(new_label){
  /* Deletes the selected instances. NOTE: Deletions persist to the db. */
  var oTT = TableTools.fnGetInstance( 'dataset-table' );
  var selected = oTT.fnGetSelected( oTable );
  // Remove selected from table
  $.ajax({
    url: "{% url 'datasets:update_instances_labels' dataset.pk label_name_id %}",
    type: "POST",
    data: {"new_label": new_label, "selected": get_selected_ids(selected)},
    dataType: 'json',
    success: function(new_data){
      oTT.fnSelectNone();
      // Change each of the label texts to the new label
      $.each(selected, function(index, value){
        $(value).find('td .instance-label').text(new_label);
        $(value).removeClass('active');
        $(value).addClass('success');
      });
      // Update plot
      data = new_data;
      scatterPlot();
    },
    crossDomain: false,
    cache: false,
  });
}

function get_selected_ids( selected )
/* Returns an array of ids for the selected instances. */
{
  return jQuery.map(selected, function(element) { return jQuery(element).data('id'); });
}
{% endif %}

</script>